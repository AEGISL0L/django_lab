{% extends 'base.html' %}

{% block content %}
<div class='container-fluid mt-4 px-4'>
  <div class='card shadow-sm' style='background-color: #ffffff; max-width: 1600px; margin: 0 auto;'>
    <div class='card-header bg-white border-bottom'>
      <h3 class='mb-0'>Detalls de la fórmula #{{ formula.petition_id }}</h3>
    </div>

    <div class='card-body'>
      <div class='row g-4'>
        <div class='col-12 col-lg-8'>
          <h5 class='mb-3'>Informació general</h5>

          <dl class='row g-3'>
            <dt class='col-sm-4 text-muted'>Nom</dt>
            <dd class='col-sm-8 fw-semibold'>{{ formula.nombre }}</dd>

            <dt class='col-sm-4 text-muted'>Estat</dt>
            <dd class='col-sm-8'>
              <div class='d-flex align-items-start'>
                <span class='badge rounded-pill {% if formula.estado == "COMPLETADO" %}bg-success{% else %}bg-warning{% endif %} px-3'>
                  {{ formula.get_estado_display }}
                </span>

                {# En Flask era RoleEnum; en Django simplificamos: autenticado = puede intentar (la vista ya valida permisos) #}
                {% if user.is_authenticated %}
                  <form action="{% url 'formulations:cambiar_estado_formula' petition_id=formula.petition_id %}" method='post' class='ms-2'>
                    {% csrf_token %}
                    <div class='input-group'>
                      {# Si pasas status_form desde la vista, úsalo; si no, renderiza manual #}
                      {% if status_form %}
                        {{ status_form.estado }}
                      {% else %}
                        <select name='estado' class='form-select'>
                          <option value='RECIBIDA' {% if formula.estado == 'RECIBIDA' %}selected{% endif %}>Recibida</option>
                          <option value='EN_PREPARACION' {% if formula.estado == 'EN_PREPARACION' %}selected{% endif %}>En Preparación</option>
                          <option value='COMPLETADO' {% if formula.estado == 'COMPLETADO' %}selected{% endif %}>Completado</option>
                          <option value='CANCELADO' {% if formula.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                        </select>
                      {% endif %}
                      <button type='submit' class='btn btn-primary'>Actualizar Estado</button>
                    </div>
                  </form>
                {% endif %}
              </div>
            </dd>

            <dt class='col-sm-4 text-muted'>Data sol·licitud</dt>
            <dd class='col-sm-8'>{{ formula.fecha_solicitud|date:'Y-m-d H:i' }}</dd>

            <dt class='col-sm-4 text-muted'>Telèfon</dt>
            <dd class='col-sm-8'><i class='bi bi-telephone-fill me-2'></i>{{ formula.telefono_contacto }}</dd>

            <dt class='col-sm-4 text-muted'>Requereix RELE?</dt>
            <dd class='col-sm-8'>
              <i class='bi {% if formula.requiere_rele %}bi-check-circle-fill text-success{% else %}bi-x-circle-fill text-danger{% endif %} me-2'></i>
              {% if formula.requiere_rele %}Sí{% else %}No{% endif %}
            </dd>
          </dl>
        </div>

        <div class='col-12 col-lg-4'>
          {% if formula.foto_receta %}
            <h5 class='mb-3'>Recepta</h5>
            <div class='ratio ratio-16x9 shadow-sm rounded overflow-hidden'>
              <img
                src='{{ formula.foto_receta.url }}'
                class='img-fluid object-fit-cover hover-zoom'
                alt='Recepta'
                onclick="window.open(this.src, '_blank')"
                style='cursor: pointer; transition: transform .3s;'
              >
            </div>
          {% endif %}
        </div>
      </div>

      <div class='row mt-4'>
        <div class='col-12'>
          <h5 class='mb-3'>Descripció</h5>
          <p class='mb-0'>{{ formula.descripcion|default_if_none:'' }}</p>
        </div>
      </div>

      {% if user.is_authenticated %}
        <div class='row mt-4'>
          <div class='col-12'>
            <div class='d-flex justify-content-between align-items-center'>
              <h5>Notes de Laboratori</h5>
              <div>
                <button type='button' class='btn btn-primary me-2' data-bs-toggle='modal' data-bs-target='#notasModal'>
                  Afegir/Editar Notes
                </button>
                <a href="{% url 'formulations:ver_timeline_formula' petition_id=formula.petition_id %}" class='btn btn-primary'>
                  Veure Timeline
                </a>
              </div>
            </div>

            <p class='mt-3'>{{ formula.notas_laboratorio|default_if_none:'' }}</p>
          </div>
        </div>

        <div class='modal fade' id='notasModal' tabindex='-1' aria-labelledby='notasModalLabel' aria-hidden='true'>
          <div class='modal-dialog'>
            <div class='modal-content'>
              <div class='modal-header'>
                <h5 class='modal-title' id='notasModalLabel'>Notas de Laboratorio</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
              </div>

              <form action="{% url 'formulations:agregar_notas_formula' petition_id=formula.petition_id %}" method='post'>
                {% csrf_token %}
                <div class='modal-body'>
                  <div class='form-group'>
                    {% if notes_form %}
                      {{ notes_form.notas_laboratorio }}
                    {% else %}
                      <textarea name='notas_laboratorio' class='form-control' rows='4'>{{ formula.notas_laboratorio|default_if_none:'' }}</textarea>
                    {% endif %}
                  </div>
                </div>

                <div class='modal-footer'>
                  <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cerrar</button>
                  <button type='submit' class='btn btn-primary'>Guardar Notas</button>
                </div>
              </form>

            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
